<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        .image-part {
            position: absolute;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
        }

        .image-part.paused {
            animation-play-state: paused;
        }

        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 10vw;
            /* 50% of viewport width */
            color: black;
            transform: translate(-50%, -50%);
            /* Centering */
            z-index: 2;
            /* Stay on top */
        }

        #info {
            position: absolute;
            bottom: 0;
            left: 0;
            font-size: 25px;
            font-weight: bolder;
            color: black;
            z-index: 2;
            /* Stay on top */
        }

        #initial {
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 25px;
            font-weight: bolder;
            color: black;
            z-index: 2;
            /* Stay on top */
        }

        #game-container {
            position: relative;
            z-index: 1;
            /* Stay below info and countdown */
        }

        .image-part.playing {
            animation-play-state: running;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="countdown"></div>
        <div id="initial">Press spacebar to load first image...</div>
        <div id="info"></div>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-voronoi.v1.min.js"></script>

    <script>
        // Add your image file names here
        const imageFiles = [
            '1.png',
            '2.png',
            '3.png',
            '4.png',
            '5.png',
            '6.png',
            '7.png',
            '8.png',
            '9.png',
            '10.png',
            '11.png',
            '12.png',
            '13.png',
            '14.png',
            '15.png',
            '16.png',
            '17.png',
            '18.png',
            '19.png',
            '20.png',
            '21.png',
            '22.png',
            '23.png',
            '24.png',
            '25.png',
            '26.png',
            '27.png',
            '28.png',
            '29.png',
            '30.png',
            '31.png',
            '32.png',
            '33.png',
            '34.png',
            '35.png',
            '36.png',
            '37.png',
            '38.png',
            '39.png',
            '40.png',
            '41.png',
            '42.png',
            '43.png',
            '44.png',
            '45.png',
            '46.png',
            '47.png',
            '48.png',
            '49.png',
        ];
        let currentImageIndex = 0;
        const infoElement = document.getElementById('info');
        const initialElement = document.getElementById('initial');

        const numParts = 250
        let partInterval;
        let polygonMasks = [];
        let isImageLoaded = false;
        let isImagePlaying = false;
        let partsRevealed = 0;
        let imageParts = [];
        let visibleParts = [];
        let hiddenParts = [];

        for (let i = 0; i < numParts; i++) {
            const pointX = Math.random();
            const pointY = Math.random();
            polygonMasks.push([pointX, pointY]);
        }

        const image = new Image();
        image.onload = function () {
            isImageLoaded = true;
        };

        function loadNextImage(imageIndex) {
            // Load the next image
            const imagePath = 'images/' + imageFiles[imageIndex];
            image.src = imagePath;

            // Update the info text
            initialElement.textContent = 'Press spacebar to start...';
        }

        function splitImage() {
            let countdown = 0;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = "loading...";
            initialElement.textContent = '';

            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = "loading...";

                if (countdown <= 0) {
                    isImagePlaying = true;
                    clearInterval(countdownInterval);
                    countdownElement.textContent = '';
                    const gameContainer = document.getElementById('game-container');
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    const voronoi = d3.voronoi().extent([[0, 0], [screenWidth, screenHeight]]);
                    const polygons = voronoi.polygons(polygonMasks.map(mask => [mask[0] * screenWidth, mask[1] * screenHeight]));

                    gameContainer.style.width = `${screenWidth}px`;
                    gameContainer.style.height = `${screenHeight}px`;

                    const partCanvas = document.createElement('canvas');
                    partCanvas.width = screenWidth;
                    partCanvas.height = screenHeight;
                    const partContext = partCanvas.getContext('2d');

                    partContext.drawImage(image, 0, 0, screenWidth, screenHeight);

                    const partCanvasDataUrl = partCanvas.toDataURL();

                    polygons.forEach((polygon, i) => {
                        const part = document.createElement('div');
                        part.className = 'image-part';
                        part.style.clipPath = `polygon(${polygon.map(point => `${point[0]}px ${point[1]}px`).join(',')})`;
                        part.style.backgroundImage = `url(${partCanvasDataUrl})`;
                        part.style.width = `${screenWidth}px`;
                        part.style.height = `${screenHeight}px`;
                        part.style.opacity = '0';
                        gameContainer.appendChild(part);
                        imageParts.push(part);
                    });
                    // create these arrays somewhere in your code
                    hiddenParts = Array.from(imageParts)
                    setTimeout(() => {
                        revealParts();
                    }, 1000);
                }
            }, 1000);
        }

        function revealParts() {
            const revealCount = Math.ceil(imageParts.length / 6);
            for (let i = 0; i < revealCount; i++) {
                if (hiddenParts.length === 0) {
                    break; // if there's nothing more to reveal, break the loop
                }

                // choose a random index from the hidden parts
                const randomIndex = Math.floor(Math.random() * hiddenParts.length);

                // reveal the part and update the arrays
                hiddenParts[randomIndex].style.opacity = '1';
                visibleParts.push(hiddenParts[randomIndex]);
                hiddenParts.splice(randomIndex, 1);
            }

            // if there are no more hidden parts, set the flags
            if (hiddenParts.length === 0) {
                imageParts = [];
                clearInterval(partInterval);
                isImagePlaying = false;
                isImageLoaded = false;
            }
        }

        function resetGame() {
            clearInterval(partInterval);
            isImagePlaying = false;
            isImageLoaded = false;
            imageParts = [];
            partsRevealed = 0;

            const images = document.querySelectorAll('.image-part')
            images.forEach(image => {
                image.remove();
            });
        }

        // Handle keyboard events
        window.addEventListener('keydown', event => {
            if (event.code === 'Space') {
                event.preventDefault();
                if (isImageLoaded) {
                    if (isImagePlaying === false) {
                        splitImage();
                        initialElement.textContent = ''; // Clear the initial text
                    } else if (isImagePlaying === true) {
                        revealParts();
                    }
                } else {
                    if (isImagePlaying === false && isImageLoaded === false) {
                        if (currentImageIndex === 0) {
                            loadNextImage(currentImageIndex);
                        }
                    }
                }
            } else if (event.code === 'ArrowRight' && event.ctrlKey) {
                event.preventDefault();
                // Load the next image
                resetGame();
                currentImageIndex = (currentImageIndex + 1) % imageFiles.length;
                loadNextImage(currentImageIndex);
            } else if (event.code === 'ArrowLeft' && event.ctrlKey) {
                event.preventDefault();
                // Load the previous image
                resetGame();
                currentImageIndex = (currentImageIndex - 1 + imageFiles.length) % imageFiles.length;
                loadNextImage(currentImageIndex);
            }
        });
    </script>
</body>

</html>